---
title: "Resilient Pasture - Project Analysis Report"
author: "Belle Yong"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(glue)
library(broom)
library(stringr)
library(purrr)
library(scales)
```

## Introduction
This report presents an initial exploratory analysis for the __Resilient Pasture Project__.
The purpose of this work is to establish baseline patterns in pasture production across multiple locations in New Zealand and to assess:

- Seasonal behaviour
- Inter-annual variability
- Long-term trends in pasture growth

The results are derived from the __Whole Farm Model (WFM v8.3.a)__ using historical climate inputs.

This analysis is intended as a foundational study to support further development of the Resilient Pasture Project.

## Data Sources 
Pasture growth data were generated using WFM runs driven by __NIWA climate station data__.

Key characteristics:

- Weather data sourced from different __NIWA climate stations__
- Output is __daily__ or __periodic pasture growth rate (PGR)__
- Six paddock-level outputs per station

## Study Locations (Stations)
This analysis includes multiple stations (sites) across __New Zealand__.

Stations are grouped into regions as follows:

- __Waikato__: Ruakura, Rotorua
- __Bay of Plenty__: Tauranga, Te Puke, Whakatane
- __Northland__: Kaikohe, Kerikeri, Whangarei

Each station represents a distinct climate location.

## Plots and Paddocks 
Within each station, pasture growth is simulated for six paddocks, labelled:
__P1, P2, P3, P4, P5, P6 __

These paddocks are treated as __plots__ within a station and are assigned soil type and fertility class to represent contrasting production conditions. 
Paddocks are not separate geographic locations; rather, they are experimental plots within each station run.

```{r, include=FALSE}
save_plots <- TRUE
plots_dir <- file.path("AgPasture Plots")
dir.create(plots_dir, recursive = TRUE, showWarnings = FALSE)

save_plot <- function(filename_stub, p, width = 12, height = 7, dpi = 300) {
  if(save_plots) {
    filename_stub <- gsub("\\s+", "_", tolower(filename_stub))
    out_path <- file.path(plots_dir, paste0(filename_stub, ".png"))
    ggplot2::ggsave(out_path, plot = p, width = width, height = height, dpi = dpi)
    message(sprintf("Saved plot: %s", out_path))
  }
  invisible(p)
}
```

```{r, include=FALSE}
# Folder containing CSV files

folder         <- "Dec2025"
skip_header    <- 20
focus_station  <- "Ruakura"
out_dir        <- file.path("outputs", format(Sys.time(), "%Y%m%d-%H%M%S"))

files <- list.files(folder, pattern = "\\.csv$", full.names = TRUE)
if (length(files) == 0) stop(glue("No CSV files found in: {folder}"))
```

```{r, include=FALSE}
process_file <- function(path) {
df <- readr::read_csv(path, skip = skip_header, show_col_types = FALSE) %>%
select(-contains("Events")) %>%
rename_with(~ paste0("P", seq_along(.)), .cols = 2:7)

date_col <- names(df) %>% keep(~ .x %in% c("Parameter:", "Parameter", "Date")) %>% first()
if (is.na(date_col)) stop(glue("No date/Parameter column found in: {basename(path)}"))

df %>%
rename(Date = !!sym(date_col)) %>%
pivot_longer(cols = matches("^P\\d+$"), names_to = "Paddock", values_to = "PGR") %>%
mutate(
PGR      = suppressWarnings(as.numeric(PGR)),
DateTime = suppressWarnings(lubridate::dmy_hm(Date)),
DateTime = if_else(is.na(DateTime), lubridate::dmy(Date), DateTime),
Date     = as_date(DateTime),
Station  = str_remove(basename(path), "\\.csv$")
) %>%
drop_na(PGR, Date) %>%
select(Date, Station, Paddock, PGR)
}

all_data <- map_df(files, process_file)
```

```{r, include=FALSE}
paddock <- tibble(
Paddock   = c("P1","P2","P3","P4","P5","P6"),
Soil      = c("Horotiu","Lismore","Tokomaru","Horotiu","Lismore","Tokomaru"),
Fertility = c(1.5,1.5,1.5,1,1,1)
)

all_data <- all_data %>%
left_join(paddock, by = "Paddock")
```

```{r, include=FALSE}
min_year <- min(year(all_data$Date), na.rm = TRUE)
max_year <- max(year(all_data$Date), na.rm = TRUE)

all_data <- all_data %>%
mutate(
Year       = year(Date),
Month      = month(Date),
anchorYear = year(Date %m-% months(5)),
prodYear   = paste0(anchorYear, "/", substr(anchorYear + 1, 3, 4)),
prodMonth  = ((Month - 6) %% 12) + 1L,
monthLabel = factor(month.abb[prodMonth], levels = month.abb, ordered = TRUE),
Season     = case_when(
Month %in% c(12,1,2)  ~ "Summer",
Month %in% c(3,4,5)   ~ "Autumn",
Month %in% c(6,7,8)   ~ "Winter",
Month %in% c(9,10,11) ~ "Spring",
TRUE ~ NA_character_
)
)
```

```{r, include=FALSE}
station_region <- tibble(
Station = c('Ruakura','Rotorua','Tauranga','Te Puke','Whakatane','Kaikohe','Kerikeri','Whangarei'),
Region  = c('Waikato','Waikato','Bay of Plenty','Bay of Plenty','Bay of Plenty','Northland','Northland','Northland')
)

all_data <- all_data %>%
left_join(station_region, by = "Station")
```

```{r, include=FALSE}
# Monthly means

monthly_mean <- all_data %>%
  group_by(Station, prodYear, anchorYear, monthLabel, Season) %>%  # include anchorYear here
  summarise(mean_PGR = mean(PGR, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    short_prodYear = paste0(
      substr(prodYear, 3, 4), "/",
      substr(prodYear, 8, 9)
    )
  )

monthly_mean <- monthly_mean %>%
  left_join(station_region, by = "Station")

# Seasonal means

seasonal_mean <- all_data %>%
group_by(Station, prodYear, Season) %>%
summarise(mean_PGR = mean(PGR, na.rm = TRUE), .groups = "drop")

# Annual station means

annual_station <- all_data %>%
group_by(Station, prodYear) %>%
summarise(mean_PGR = mean(PGR, na.rm = TRUE), .groups = "drop")
```

```{r, include=FALSE}
peaks_troughs <- monthly_mean %>%
  group_by(Station, prodYear, anchorYear) %>%
  summarise(
    peak_month = monthLabel[which.max(mean_PGR)],
    peak_value = max(mean_PGR, na.rm = TRUE),
    low_month  = monthLabel[which.min(mean_PGR)],
    low_value  = min(mean_PGR, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(station_region, by = "Station")
```


```{r box_monthly_northland, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
p_box_northland <- ggplot(
  monthly_mean %>%
    filter(Region == "Northland", short_prodYear != "24/"),  # remove 24/
  aes(x = short_prodYear, y = mean_PGR)
) +
  geom_boxplot(
    outlier.alpha = 0.5,
    median.colour = "red",
    median.size   = 0.8
  ) +
  facet_wrap(~ Station, scales = "free_y", nrow = 1) +  # horizontal facets
  coord_flip() +
  labs(
    title = "Monthly Production Growth by Production Year — Northland",
    x = "Production Year",
    y = "Mean Monthly PGR"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 9),
    strip.text  = element_text(face = "bold")
  )

p_box_northland
```

```{r box_monthly_waikato, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
box_monthly_waikato <- ggplot(
  monthly_mean %>%
    filter(Region == "Waikato", short_prodYear != "24/"),  # remove 24/
  aes(x = short_prodYear, y = mean_PGR)
) +
  geom_boxplot(
    outlier.alpha = 0.5,
    median.colour = "red",
    median.size   = 0.8
  ) +
  facet_wrap(~ Station, scales = "free_y", nrow = 1) +  # horizontal facets
  coord_flip() +
  labs(
    title = "Monthly Production Growth by Production Year — Waikato",
    x = "Production Year",
    y = "Mean Monthly PGR"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 9),
    strip.text  = element_text(face = "bold")
  )

box_monthly_waikato
```

```{r box_monthly_bop, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
box_monthly_bop <- ggplot(
  monthly_mean %>%
    filter(Region == "Waikato", short_prodYear != "24/"),  # remove 24/
  aes(x = short_prodYear, y = mean_PGR)
) +
  geom_boxplot(
    outlier.alpha = 0.5,
    median.colour = "red",
    median.size   = 0.8
  ) +
  facet_wrap(~ Station, scales = "free_y", nrow = 1) +  # horizontal facets
  coord_flip() +
  labs(
    title = "Monthly Production Growth by Production Year — Bay Of Plenty",
    x = "Production Year",
    y = "Mean Monthly PGR"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 9),
    strip.text  = element_text(face = "bold")
  )

box_monthly_bop
```


```{r p_sd_points_only, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
sd_by_year <- monthly_mean %>%
  group_by(Station, prodYear, anchorYear) %>%
  summarise(sd_month = sd(mean_PGR, na.rm = TRUE), .groups = "drop")

p_sd_points_only <- ggplot(sd_by_year, aes(x = anchorYear, y = sd_month)) +
  geom_point(size = 2.5, alpha = 0.9, colour = "steelblue") +
  facet_wrap(~ Station, scales = "free_y") +
  labs(
    title = "Standard Deviation of Monthly Average Growth within Production Year",
    x = "Anchor Year (June start)", y = "SD of monthly mean PGR"
  ) +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 9),
    strip.text  = element_text(face = "bold")
  )

p_sd_points_only
```

This plot shows the __within-year variability__ of pasture growth, measured as the __standard deviation__ of monthly mean growth within each production year. Higher values indicate greater seasonal unevenness in growth during that year.

```{r p_monthly, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
p_monthly <- ggplot(monthly_mean, aes(x = monthLabel, y = mean_PGR, color = Station, group = Station)) +
geom_line() +
geom_point() +
labs(title = "Monthly Average Growth by Station", y = "Mean PGR (kg DM/ha/day)", x = "Month") +
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5))

p_monthly
```


This scatter plot examines the relationship between __overall growth level__ and __within-year variability__. It assesses whether years with higher average growth tend to exhibit greater or lower variability, which is relevant for pasture resilience and feed reliability. The results indicate that August shows the highest variability, while February exhibits the lowest variability.

```{r p_seasonal, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
p_seasonal <- ggplot(seasonal_mean, aes(x = Season, y = mean_PGR, fill = Station)) +
geom_col(position = "dodge") +
labs(title = "Seasonal Mean Pasture Growth by Station", y = "Mean PGR", x = "Season") +
theme_minimal() + 
theme(plot.title = element_text(hjust = 0.5))

p_seasonal
```

This bar plot compares the mean pasture growth (PGR) for each season across different __stations__ with bars grouped side by side for each season. This can help identify how PGR varies by season and station, showing there is the most PGR variation during summer and least during winter. The station __Kaikohe__ has the most and least variation among the 8 stations. 

```{r peak_trough_plot, fig.align='center', echo=FALSE}
p_lollipop_peak_low <- ggplot(peaks_troughs, aes(x = anchorYear)) +
  geom_segment(
    aes(y = low_value, yend = peak_value, xend = anchorYear),
    colour = "grey70"
  ) +
  geom_point(aes(y = peak_value), colour = "darkgreen", size = 2) +
  geom_point(aes(y = low_value),  colour = "firebrick", size = 2) +
  geom_text(
    aes(y = peak_value, label = peak_month),
    colour = "darkgreen", vjust = -0.8, size = 3
  ) +
  geom_text(
    aes(y = low_value, label = low_month),
    colour = "firebrick", vjust = 1.4, size = 3
  ) +
  facet_wrap(~ Station, scales = "free_y") +
  labs(
    title = "Peak and Trough Monthly Mean Growth",
    x = "Production Year", y = "Mean Monthly PGR"
  ) +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5))

p_lollipop_peak_low
```

This lollipop plot visualizes the peak and through through months of PGR per production year for each station. It shows the best and worst performing months. 

```{r violin_station_season, fig.align='center', echo=FALSE}
season_cols <- c(
  "Summer"="#F2C14E",
  "Autumn"="#D96C06",
  "Winter"="#3772A1",
  "Spring"="#2E8B57"
)

p_violin <- ggplot(monthly_mean, aes(x = Station, y = mean_PGR, fill = Season)) +
  geom_violin(trim = TRUE, alpha = 0.6) +
  scale_fill_manual(values = season_cols) +
  coord_flip() +
  labs(
    title = "Distribution of Monthly PGR by Station and Season",
    x = "Station", y = "Mean Monthly PGR"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

p_violin
```

This violin plot display the distribution of PGR by station and season.